name: Docker Live Integration Tests

# This workflow is disabled by default and must be triggered manually
# It performs resource-intensive Docker integration tests
on:
  workflow_dispatch:  # Manual trigger only

jobs:
  docker-live-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Verify Docker installation
      run: |
        docker --version
        docker info
    
    - name: Install ffmpeg for test video creation
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        ffmpeg -version
    
    - name: Run Docker live integration test
      run: |
        pytest test_docker_live.py -v -s
      timeout-minutes: 10
    
    - name: Show test artifacts on failure
      if: failure()
      run: |
        echo "Listing any leftover test files..."
        find /tmp -name "*docker_test*" -type d 2>/dev/null || true
        
        echo "Docker containers:"
        docker ps -a
        
        echo "Docker images:"
        docker images
    
    - name: Cleanup Docker resources
      if: always()
      run: |
        # Clean up any leftover test containers
        docker ps -a --filter "name=convert_videos_test" --format "{{.Names}}" | xargs -r docker rm -f || true
        
        # Clean up test images
        docker images --filter "reference=convert_videos_test" --format "{{.Repository}}:{{.Tag}}" | xargs -r docker rmi -f || true
        
        echo "Cleanup complete"
